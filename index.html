<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Dave Arrows Digital assistant</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://use.fontawesome.com/3375840c43.js"></script>
    <script src="https://aframe.io/releases/1.0.3/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/matthewbryancurtis/aframe-star-system-component/db4f1030/index.js"></script> 
    <script src="https://rawgit.com/mayognaise/aframe-mouse-cursor-component/master/dist/aframe-mouse-cursor-component.min.js"></script>
</head>
<body>
    <a-scene embedded  loading-screen="dotsColor: red; backgroundColor: black">
        <a-assests>
            <a-asset-item  id="cityModel" src="./landscape.glb"></a-asset-item>
        </a-assests>
        <a-light
        type="point" 
        color="#FFAE64"
        position="4.7 4.5 -0.4"
        rotation="0 210 0"></a-light>
        <a-mixin id="giant" scale="0.4 0.2 0.2"></a-mixin>
        <a-light type="point" color="#FFAE64" position="0 4.5 -7"></a-light>
        <a-entity id="rig"  position="0 3.5 0"
       >
           <a-entity camera look-controls mouse-cursor>
                <a-cursor fuse="false" color="yellow"
               
                ></a-cursor>
                
              </a-entity>
        </a-entity>
      
        <a-entity gltf-model="#cityModel" rotation="0 210 0" position="0 1 -7" scale="0.5 0.5 0.5"></a-entity>
        <a-sky color="black"></a-sky>
        <a-entity star-system></a-entity>
        <a-entity 
            id="cube" 
            class="clickable"
            light="type: point; intensity: 2.0"
            position="-1.0 3 -4.8"
            geometry="primitive: box" material="color: red; opacity: 0.6"
            animation="property: rotation; to: 360 360 360; loop: true; dur: 5000; easing: linear;"       
            event-set__enter="_event: mouseenter; material.color: yellowgreen; scale: 3 1 1"
            event-set__leave="_event: mouseleave; material.color: skyblue; scale: 1 1 1">
            <a-entity 
                scale="0.2 0.2 0.2"
                animation="property: scale; dir: alternate; dur: 1600; loop: true; to: 0.4 0.4 0.4"
                geometry="primitive: box" material="color: red"
                />

        </a-entity>
        
    </a-scene>
  
  <div id="webchat"></div>
  <script src="https://storage.googleapis.com/mrbot-cdn/webchat-latest.js"></script>

</body>
<script>
  var state = {
    toggle: false
  }




   document.querySelector('#webchat').addEventListener('click', function () {
     console.log('listening');
        changeColor();
        if(state.toggle){ 
        moveCamera();
        animateAvatar();
        listen();
        }else{
        moveCamera([4,4,0],[-12,12,5]);
        animateAvatar([1.5,3.5,-2]);
        }
        state.toggle = !(state.toggle);
    });


    changeColor =(newColor=null) => {
    const colors = ['red', 'orange', 'yellow', 'green', 'blue', 'blue'];
    let colorToChangeTo = (newColor == null|undefined) ? (colors[Math.floor(Math.random() * colors.length)]) : newColor ;
    console.log(colorToChangeTo);
    document.querySelector('#cube').setAttribute('material',"color:"+ colorToChangeTo +"; opacity: 0.6")
    }

    moveCamera = (point=[0, 3.5 ,0],rotation=[0,0,0])=>{
      let rig = document.querySelector('#rig');
      rig.setAttribute('animation',"property:position; dir: alternate; dur: 1600; loop: false; to:"+point[0]+" "+point[1]+" "+point[2]);
      rig.setAttribute('animation__2',"property:rotation;  dur: 1600; to:"+rotation[0]+" "+rotation[1]+" "+rotation[2]);
     
    }
    
    animateAvatar = (point=[-1.0, 3, -4.8]) => {
      let avatar = document.querySelector('#cube');
      avatar.setAttribute('animation__2',"property:position; dur: 1600; loop: false; to:"+point[0]+" "+point[1]+" "+point[2]);
    }



    listen = () =>  { 
    window.SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
    window.SpeechGrammarList = window.webitSpeechGrammarList || window.SpeechGrammarList;
    const recognition = new window.SpeechRecognition();

    
    if (!'SpeechRecognition' in window) {
      upgrade();
      console.error('speech not supported')
    } else {
      recognition.lang = 'en-US';
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.start();
      console.log('Ready to receive input.');
      let i = 0;

      recognition.onresult = function(event) {
        var synth = window.speechSynthesis;
        var interim_transcript,final_transcript  = '';

        for (var i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            final_transcript += event.results[i][0].transcript;
            document.querySelector('.rw-new-message').value = final_transcript;
            document.querySelector('.rw-send').disabled = false
            console.log(document.querySelector('.rw-send'));
            document.querySelector('.rw-send').click();
          } else {
            console.log(event.results[i][0].transcript)
            interim_transcript += (!event.results[i][0].transcript == undefined) ? event.results[i][0].transcript : "" ;
            document.querySelector('.rw-new-message').value += (!event.results[i][0].transcript == undefined) ? event.results[i][0].transcript : "" ; ;
          }
        }   
      }
    }
  }


spokenReply = (message) => {

    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioContext = new AudioContext();
    let currentBuffer = null;
    var synth = window.speechSynthesis;
    var utterThis = new SpeechSynthesisUtterance(message);
    utterThis.voice = (window.chrome) ? synth.getVoices()[3] : synth.getVoices()[0];
    synth.speak(utterThis);
    utterThis.onend = function(event) {
    console.log('Utterance has finished being spoken after ' + event.elapsedTime + ' milliseconds.');
  }

    listen();


    }

  WebChat.default.init({
    selector: "#webchat",
    initPayload: "/get_started",
    customData: {"language": "en"}, 
    socketUrl: "https://digitalinterview.nz",
    socketPath: "/socket.io/",
    title: "Digital assistant",
    subtitle: "chat",
    docViewer:true,
    customMessageDelay:(message) => {
      console.log(message);
      spokenReply(message);
     
    },
    
    
  })

listen();



</script>
</html>